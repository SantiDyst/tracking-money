<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Gastos</title>
    <link rel="manifest" href="/tracking-money/manifest.json">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Control de Gastos">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #ecf0f1;
            --accent: #3498db;
            --expense: #e74c3c;
            --background: #f9f9f9;
        }
        
        /* Modo oscuro */
        .dark {
            --background: #1a1a1a;
            --primary: #34495e;
            --secondary: #ecf0f1;
            --accent: #3498db;
            --expense: #e74c3c;
        }
        
        .dark body {
            background-color: #1a1a1a;
            color: #ecf0f1;
        }
        
        .dark .balance-container,
        .dark .expense-form,
        .dark .expenses-table {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        
        .dark .balance-container input,
        .dark .form-group input,
        .dark .form-group textarea,
        .dark .form-group select {
            background-color: #34495e;
            color: #ecf0f1;
            border-color: #566573;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Saldo Restante - Verde positivo */
        #remaining-balance {
            background-color: #f0f9f0;
            color: #2ecc71;
            font-weight: bold;
            border: 1px solid #d5f5e3;
        }

        /* Total Gastados - Rojo negativo */ 
        #total-expenses {
            background-color: #fef5f5;
            color: #e74c3c;
            font-weight: bold;
            border: 1px solid #fadbd8;
        }

        /* Monto del Gasto - Azul */
        #expense-amount {
            background-color: #f0f8ff;
            border: 1px solid #d6eaf8;
        }

        /* Motivo - Gris suave */
        #expense-reason {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        /* Estilos para modo oscuro */
        .dark #remaining-balance {
            background-color: #1c331c;
            color: #27ae60;
            border-color: #2ecc71;
        }

        .dark #total-expenses {
            background-color: #3c1c1c;
            color: #c0392b;
            border-color: #e74c3c;
        }

        .dark #expense-amount {
            background-color: #1c2c3c;
            border-color: #3498db;
        }

        .dark #expense-reason {
            background-color: #2c3c4c;
            border-color: #566573;
        }

        /* Estilos comunes para inputs de solo lectura */
        #remaining-balance, #total-expenses {
            cursor: not-allowed;
        }

        body {
            background-color: var(--background);
            color: var(--primary);
            padding: 15px;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: var(--primary);
            color: var(--secondary);
            border-radius: 8px;
            position: relative;
        }
        
        .balance-container {
            background-color: rgb(255, 255, 255);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .balance-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .balance-container input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 18px;
            text-align: right;
        }
        
        .expense-form {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .form-group textarea {
            min-height: 60px;
            resize: vertical;
        }
        
        button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        
        button:hover {
            background-color: #2980b9;
        }

        .expenses-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .expenses-table th {
            background-color: var(--primary);
            color: var(--secondary);
            padding: 12px;
            text-align: left;
        }
        
        .expenses-table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        
        .expenses-table tr:last-child td {
            border-bottom: none;
        }
        
        .amount {
            text-align: right;
            color: var(--expense);
            font-weight: bold;
        }
        
        .date {
            white-space: nowrap;
        }
        
        .reason {
            word-break: break-word;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 16px;
            padding: 0 5px;
            width: auto;
        }
        
        .delete-btn:hover {
            color: var(--expense);
        }
        
        /* Toggle de tema */
        .theme-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: 1px solid var(--secondary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            color: var(--secondary);
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .update-btn {
            position: fixed;
            top: 80px;
            right: 10px;
            z-index: 9999;
            background: rgba(230, 126, 34, 0.3); /* Más transparente */
            color: rgba(255, 255, 255, 0.6); /* Texto más suave */
            border: none;
            padding: 6px 10px; /* Más pequeño */
            border-radius: 15px;
            cursor: pointer;
            font-size: 10px; /* Texto más pequeño */
            box-shadow: none; /* Sin sombra */
            opacity: 0.4; /* Muy transparente */
            transition: opacity 0.3s ease;
        }
        
        .update-btn:hover {
            opacity: 1; /* Solo se ve completo al hacer hover */
            background: #e67e22;
            color: white;
        }
        
        @media (max-width: 480px) {
            .expenses-table {
                font-size: 14px;
            }
            
            .expenses-table th, 
            .expenses-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Control de Gastos</h1>
        <button class="theme-toggle" onclick="toggleTheme()">🌙</button>
    </header>
    
    <button class="update-btn" onclick="clearSW()">
        ♻️ Actualizar App
    </button>
    
    <div class="balance-container">
        <label for="remaining-balance">Saldo Restante:</label>
        <input type="text" id="remaining-balance" readonly value="0.00">
    </div>

    <div class="balance-container">
        <label for="initial-balance">Saldo Inicial:</label>
        <input type="number" id="initial-balance" step="0.01" placeholder="0.00" value="262.00">
    </div>
    
    <div class="expense-form">
        <div class="form-group">
            <label for="expense-amount">Monto del Gasto:</label>
            <input type="number" id="expense-amount" step="0.01" placeholder="0.00">
        </div>
        
        <div class="form-group">
            <label for="expense-reason">Motivo:</label>
            <textarea id="expense-reason" placeholder="Descripción del gasto"></textarea>
        </div>

        <div class="form-group">
            <label for="expense-category">Categoría:</label>
            <select id="expense-category">
                <option value="comida">🍔 Comida</option>
                <option value="transporte">🚗 Transporte</option>
                <option value="entretenimiento">🎬 Entretenimiento</option>
                <option value="salud">⚕️ Salud</option>
                <option value="otros">📦 Otros</option>
            </select>
        </div>
        
        <button id="add-expense">Agregar Gasto</button>
    </div>
    
    <div class="balance-container">
        <label for="total-expenses">Total Gastados:</label>
        <input type="text" id="total-expenses" readonly value="0.00">
    </div>

    <table class="expenses-table">
        <thead>
            <tr>
                <th>Monto</th>
                <th>Motivo</th>
                <th>Categoría</th>
                <th>Fecha</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="expenses-list">
        </tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos del DOM
            const initialBalanceInput = document.getElementById('initial-balance');
            const expenseAmountInput = document.getElementById('expense-amount');
            const expenseReasonInput = document.getElementById('expense-reason');
            const expenseCategorySelect = document.getElementById('expense-category');
            const addExpenseButton = document.getElementById('add-expense');
            const expensesList = document.getElementById('expenses-list');
            
            // Cargar datos guardados
            let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            let initialBalance = parseFloat(localStorage.getItem('initialBalance')) || 0;
            
            // Cargar tema guardado
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
                document.querySelector('.theme-toggle').textContent = '☀️';
            }
            
            // Establecer saldo inicial
            initialBalanceInput.value = initialBalance.toFixed(2);
            if (initialBalance === 0) {
                initialBalanceInput.value = '';
            }
            updateRemainingBalance();
            
            // Mostrar gastos existentes
            expenses.forEach(expense => {
                addExpenseToDOM(expense);
            });
            
            // Validar saldo inicial
            initialBalanceInput.addEventListener('change', function() {
                const value = parseFloat(this.value) || 0;
                if (value < 0) {
                    alert('El saldo inicial no puede ser negativo');
                    this.value = '0';
                    return;
                }
                initialBalance = value;
                localStorage.setItem('initialBalance', initialBalance);
                updateRemainingBalance();
            });
            
            // Navegación con Enter
            expenseAmountInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    expenseReasonInput.focus();
                }
            });

            expenseReasonInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addExpenseButton.click();
                }
            });
            
            // Evento para agregar gasto
            addExpenseButton.addEventListener('click', function() {
                const amount = parseFloat(expenseAmountInput.value);
                const reason = expenseReasonInput.value.trim();
                const category = expenseCategorySelect.value;
                
                if (isNaN(amount) || amount <= 0) {
                    alert('Por favor ingresa un monto válido.');
                    return;
                }
                
                if (reason === '') {
                    alert('Por favor ingresa un motivo.');
                    return;
                }
                
                const newExpense = {
                    amount: amount,
                    reason: reason,
                    category: category,
                    date: new Date().toLocaleDateString('es-ES')
                };
                
                expenses.push(newExpense);
                localStorage.setItem('expenses', JSON.stringify(expenses));
                
                addExpenseToDOM(newExpense);
                updateRemainingBalance();
                
                // Limpiar formulario
                expenseAmountInput.value = '';
                expenseReasonInput.value = '';
                expenseCategorySelect.selectedIndex = 0;
            });
            
            // Función para agregar gasto a la tabla
            function addExpenseToDOM(expense) {
                const row = document.createElement('tr');
                
                // Para gastos existentes sin categoría
                const categoryIcon = getCategoryIcon(expense.category || 'otros');
                
                row.innerHTML = `
                    <td class="amount">-${expense.amount.toFixed(2)}</td>
                    <td class="reason">${expense.reason}</td>
                    <td>${categoryIcon}</td>
                    <td class="date">${expense.date}</td>
                    <td>
                        <button class="delete-btn">×</button>
                    </td>
                `;
                
                // Evento para eliminar gasto - CORREGIDO
                row.querySelector('.delete-btn').addEventListener('click', function() {
                    if (confirm('¿Estás seguro de eliminar este gasto?')) {
                        const index = expenses.findIndex(e => 
                            e.amount === expense.amount && 
                            e.reason === expense.reason && 
                            e.date === expense.date
                        );
                        
                        if (index !== -1) {
                            expenses.splice(index, 1);
                            localStorage.setItem('expenses', JSON.stringify(expenses));
                            row.remove();
                            updateRemainingBalance();
                        }
                    }
                });
                
                expensesList.appendChild(row);
            }
            
            // Función para obtener ícono de categoría
            function getCategoryIcon(category) {
                const icons = {
                    comida: '🍔',
                    transporte: '🚗',
                    entretenimiento: '🎬',
                    salud: '⚕️',
                    otros: '📦'
                };
                return icons[category] || '📦';
            }
            
            // Función para actualizar el saldo restante
            function updateRemainingBalance() {
                const totalExpenses = expenses.reduce((total, expense) => total + expense.amount, 0);
                const remainingBalance = initialBalance - totalExpenses;
                
                document.getElementById('remaining-balance').value = remainingBalance.toFixed(2);
                document.getElementById('total-expenses').value = totalExpenses.toFixed(2);
            }
        });

        // Función para cambiar tema
        function toggleTheme() {
            document.body.classList.toggle('dark');
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (document.body.classList.contains('dark')) {
                themeToggle.textContent = '☀️';
                localStorage.setItem('theme', 'dark');
            } else {
                themeToggle.textContent = '🌙';
                localStorage.setItem('theme', 'light');
            }
        }

        // PWA y Service Worker
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            if (isMobile) {
                showInstallButton();
            }
        });

        function showInstallButton() {
            const installBtn = document.createElement('button');
            installBtn.innerHTML = '📲 Instalar App';
            installBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #3498db;
                color: white;
                border: none;
                padding: 12px 18px;
                border-radius: 25px;
                cursor: pointer;
                z-index: 1000;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                font-weight: bold;
            `;
            
            installBtn.onclick = async () => {
                if (!deferredPrompt) return;
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    installBtn.remove();
                }
                deferredPrompt = null;
            };
            
            document.body.appendChild(installBtn);
        }

        // Función para limpiar cache
        function clearSW() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => registration.unregister());
                    caches.keys().then(cacheNames => {
                        cacheNames.forEach(cacheName => caches.delete(cacheName));
                    });
                    alert('Cache limpiado. Recarga la página.');
                    location.reload();
                });
            }
        }

        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/tracking-money/sw.js');
                    console.log('SW registrado:', registration);
                } catch (error) {
                    console.log('Error SW:', error);
                }
            });
        }

        // Auto-actualización
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });

            setInterval(() => {
                navigator.serviceWorker.getRegistration('/tracking-money/').then(reg => {
                    if (reg) reg.update();
                });
            }, 60000);
        }
    </script>
</body>
</html>